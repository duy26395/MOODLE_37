define(['jquery', 'kendo.all.min', 'core/config', 'core/notification', 'dttable', 'core/str'], function($, kendo, Config, Notification, dttable, Str) {

  //loại bỏ thẻ html
  function strip_tags(str) {
    str = str.toString();
    return str.replace(/<\/?[^>]+>/gi, '');
  } 

    return {
        orgmain: function() {
            $body = $('body');
            var st = $("#search-term").val();
            var data;
            var tv;
            var clicktable;
            var data_clicktable;
            var settings = {
              type: 'GET',
              data: {
                org_struct: 1
            },
            processData: true,
            contentType: "application/json"
            };
            var script = Config.wwwroot + '/local/newsvnr/ajax.php';
            $('[data-region="buttons-iframe"] #userdetail_orgstructure').click(function(){
              $('[data-region="userdetail-iframe"]').removeClass("d-none");      
            });
            $body.addClass("loading");
            $.ajax(script, settings)
            .then(function(response) {
              if (response.error) {
                  Notification.addNotification({
                      message: response.error,
                      type: "error"
                  });
              } else {
                  // Reload the page, don't show changed data warnings.
                  if (typeof window.M.core_formchangechecker !== "undefined") {
                      window.M.core_formchangechecker.reset_form_dirty_state();
                  }
                  $('#search-term').on('keyup', function() {
                      var treeView = $("#treeview-sprites").getKendoTreeView();
                      treeView.dataSource.data(data);

                      // ignore if no search term
                      if ($.trim($(this).val()) == '') {
                          return;
                      }

                      var term = this.value.toUpperCase();
                      var tlen = term.length;

                      $('#treeview-sprites span.k-in').each(function(index) {
                          var text = $(this).text();

                          var html = '';
                          var q = 0;
                          while ((p = text.toUpperCase().indexOf(term, q)) >= 0) {
                              html += text.substring(q, p) + '<span class="highlight">' + text.substr(p, tlen) + '</span>';
                              q = p + tlen;
                          }

                          if (q > 0) {
                              html += text.substring(q);

                              var dataItem = treeView.dataItem($(this));
                              dataItem.set("text", html);

                              $(this).parentsUntil('.k-treeview').filter('.k-item').each(

                                  function(index, element) {
                                      $('#treeview-sprites').data('kendoTreeView').expand($(this));
                                      $(this).data('search-term', term);
                                  });
                          }
                      });

                      $('#treeview-sprites .k-item').each(function() {
                          if ($(this).data('search-term') != term) {
                              $('#treeview-sprites').data('kendoTreeView').collapse($(this));
                          }
                      });
                  });
                  // window.location.reload();
                  data = JSON.parse(response);
                  tv = $("#treeview-sprites").kendoTreeView({
                      dataSource: data
                  }).data('kendoTreeView');
                  $body.removeClass("loading");
                  
              }

              return;
            }).fail(Notification.exception);
            //click vào cây phòng ban
            $('#treeview-sprites').on('click','',function() {
              $('[data-region="buttons-iframe"] #list_users').removeClass("btn-primary");
              $('[data-region="buttons-iframe"] #list_users').removeAttr('disabled');
              $('[data-region="buttons-iframe"] #orgstructuredetail').removeAttr('disabled');

              var selected = tv.select(),
              item = tv.dataItem(selected);
              if (item) {
                  var itemid = item.id;
                  var itemtext = item.text;
                  document.getElementById("search-term").value = strip_tags(itemtext);
              }
              var settings = {
                  // async: false,
                  type: 'GET',
                  data: {
                      section: 'orgmain_list',
                      orgstructureid: itemid
                  },
                  processData: true,
                  contentType: "application/json"
              };

              $body.addClass("loading");  
              var script = Config.wwwroot + '/local/newsvnr/ajax/orgdata.php';
              $body.removeClass("loading");
              $.ajax(script, settings)
              .then(function(response) {

                  if (response.error) {
                      Notification.addNotification({
                          message: response.error,
                          type: "error"
                      });
                  } else {
                      var strings = [{
                          key: 'nodatatable',
                          component: 'local_newsvnr'
                      }, ];
                      Str.get_strings(strings).then(function(s) {
                        var data = JSON.parse(response);
                        $('#showtable_data').html(data.header);
                        $('#show_orgform').html(data.form);
                        var table = $('#orgmain_datatable').DataTable({
                            "dom": 'frtip',
                            "language": {
                                "emptyTable": s[0]
                            },
                            "scrollX": true,                          
                        });
                        $body.removeClass("loading");
                        var click_orgdetail = $('[data-region="buttons-iframe"] #orgstructuredetail').click(function() {
                            $('#show_orgform').removeClass("d-none");
                            $('#showtable_data').addClass("d-none");
                    
                        });
                        var click_listusers = $('[data-region="buttons-iframe"] #list_users').click(function() {
                            $('#showtable_data').removeClass("d-none");
                            $('#show_orgform').addClass("d-none");

                        });
                        var clicktable = $('#orgmain_datatable tbody').on('dblclick', 'tr', function () {            
                        var data_clicktable = table.row( this ).data();
                       
                        var settings5 = {
                              // async: false,
                            type: 'GET',
                            data: {
                                section: 'orgmain_list',
                                modalsection: 'modalinfo',
                                orgstructureid:itemid,
                                usercode:data_clicktable[0]
                            
                            },
                            processData: true,
                            contentType: "application/json"
                        };
                        var script5 = Config.wwwroot + '/local/newsvnr/ajax/orgdata.php';
                          if (data_clicktable !== 'undefined') {
                            $body.addClass("loading");
                          $.ajax(script5,settings5)
                          .then(function(response){
                                var data = JSON.parse(response);
                                $('#showmodal_data').html(data.modal);
                                $('#userdetail').modal('toggle');
                                $('#userdetailtable').DataTable({
                                    "dom": 'frtip',
                                    "language": {
                                        "emptyTable": s[0]
                                    },
                                    "scrollX": true,
                                    
                                });
                                $body.removeClass("loading"); 
                          }).fail(Notification.exception);
                        }
                      }); 
                    });

                  }
                  return;
              }).fail(Notification.exception);
            });
          
        }
    };
});